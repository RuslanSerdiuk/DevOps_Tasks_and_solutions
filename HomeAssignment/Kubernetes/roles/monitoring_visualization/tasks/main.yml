
- name: Download Helm command line tool
  ansible.builtin.uri:
    url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    return_content: true
  register: helm_installer


- name: Install Helm
  ansible.builtin.command:
    cmd: bash
    stdin: "{{ helm_installer.content }}"
    creates: /usr/local/bin/helm
  environment:
    DESIRED_VERSION: "{{ helm_version | default('') }}"



- name: Add prometheus-community chart repo
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: "https://prometheus-community.github.io/helm-charts"
    kubeconfig: "/home/ubuntu/.kube/config"
    state: present
    
- name: Add Grafana chart repo
  kubernetes.core.helm_repository:
    name: grafana
    repo_url: "https://grafana.github.io/helm-charts"
    kubeconfig: "/home/ubuntu/.kube/config"
    state: present
    
- name: Deploy Grafana chart inside monitoring namespace
  kubernetes.core.helm:
    name: test
    chart_ref: prometheus-community/kube-prometheus-stack
    release_namespace: "{{ namespace }}"
    state: absent
    kubeconfig: "/home/ubuntu/.kube/config"



- name: Add elasticsearch chart repo
  kubernetes.core.helm_repository:
    name: elastic
    repo_url: "https://helm.elastic.co"
    kubeconfig: "/home/ubuntu/.kube/config"
    state: present
    
- name: Deploy Elasticsearch chart inside logging namespace (and create it)
  kubernetes.core.helm:
    name: elasticsearch
    chart_ref: elastic/elasticsearch
    release_namespace: "logging"
    create_namespace: true
    values: "{{ lookup('template', 'value.yaml') | from_yaml }}"
    state: present
    kubeconfig: "/home/ubuntu/.kube/config"


- name: Deploy Kibana chart inside logging namespace
  kubernetes.core.helm:
    name: kibana
    chart_ref: elastic/kibana
    release_namespace: "logging"
    state: absent
    kubeconfig: "/home/ubuntu/.kube/config"


- name: Deploy Filebeat chart inside logging namespace
  kubernetes.core.helm:
    name: filebeat
    chart_ref: elastic/filebeat
    release_namespace: "logging"
    state: absent
    kubeconfig: "/home/ubuntu/.kube/config"


