pipeline {
    agent {
        label 'ec2-agent'
    }
    options {
        buildDiscarder(logRotator(numToKeepStr: '5'))
    }
    environment {
        ECR_CREDENTIALS = credentials('ecr-creds')
    }
    stages {
        stage('Delete workspace before build starts') {
            steps {
                echo 'Deleting workspace'
                deleteDir()
            }
        }
        stage('Checkout') {
            steps{
                git branch: "Jenkins-Setup-Configure", credentialsId: 'github-creds-jenkins-task', url: 'https://github.com/RuslanSerdiuk/DevOps_Tasks_and_solutions.git'
                }
        }
        stage('Check CloudFormation Stack') {
            steps {
                script {
                    STACK_STATUS = sh (
                            script: 'aws cloudformation describe-stacks --stack-name jenkins-lambda | awk \'{print$2}\' | grep -oE "ROLLBACK_COMPLETE"',
                            returnStdout: true
                        ).trim()
                        echo "Stack has been Checked!"
                }
            }   
        }
        stage('Deploy Lambda') {
            when {
                    expression { STACK_STATUS != "ROLLBACK_COMPLETE" }
                }
            steps {
                script{
                    if (STACK_STATUS != "ROLLBACK_COMPLETE") {
                        sh 'aws cloudformation create-stack --stack-name jenkins-lambda --template-body file://CICD/Jenkins-Setup-configure/lambda-template.yaml'
                    }
                    else (STACK_STATUS == "ROLLBACK_COMPLETE") {
                        echo "Stack exists"
                    }
                }
            }
        }
        stage('Invoke Lambda - Type:Event') {
            steps {
                script {
                    RESPONCE = sh (
                            script: 'aws lambda invoke --invocation-type Event --function-name JenkinsTask --payload $(echo \'{"first_name": "Ruslan", "last_name": "Serdiuk"}\' | base64) out | awk \'{print $2}\'',
                            returnStdout: true
                        ).trim()
                        echo "Lambda responce code: ${RESPONCE}"
                    }
                sh 'aws lambda invoke --invocation-type Event --function-name JenkinsTask --cli-binary-format raw-in-base64-out --payload file://CICD/Jenkins-Setup-configure/payloadfile.json response.json | awk \'{print $2}\''
                currentBuild.displayName = "Executed on: ${NODE_NAME}\n Deploy on #${BRANCH} - [#${BUILD_NUMBER}]"
            }
        }
        stage('Invoke Lambda - Type:RequestResponse') {
            steps {
                sh 'aws lambda invoke --invocation-type RequestResponse --function-name JenkinsTask --payload $(echo \'{"first_name": "Ruslan", "last_name": "Serdiuk"}\' | base64) out'
                sh 'aws lambda invoke --invocation-type RequestResponse --function-name JenkinsTask --cli-binary-format raw-in-base64-out --payload file://CICD/Jenkins-Setup-configure/payloadfile.json response.json'
            }
        }
        stage('Ls work dir') {
            steps {
                sh "ls -la"
            }
        }

    }
}